# 🛒 购物清单生成逻辑分析与优化方案

## 📊 当前生成逻辑流程

### 1. 触发时机
```
用户生成膳食计划 
  ↓
膳食计划保存到数据库成功 
  ↓
立即在后台异步调用 generateShoppingListInBackground()
```

### 2. 详细步骤

#### 步骤 1：创建购物清单记录（约 0.5-1 秒）
```javascript
// 在 page.tsx 的 generateShoppingListInBackground() 中
const { data: shoppingList } = await supabase
  .from('shopping_lists')
  .insert({
    user_id: userId,
    meal_plan_id: mealPlanId,
    created_at: new Date().toISOString(),
  })
  .select()
  .single();
```

#### 步骤 2：准备 AI 请求（即时）
```javascript
// 提取所有菜谱名称
const recipeNames = mealPlan.map(m => m.recipe.name_zh || m.recipe.name_ms).join(', ');

// 构建 prompt（非常长的文本）
const prompt = `请根据以下马来西亚菜谱生成购物清单：${recipeNames}
要求：
1. 4人份，一周用量
2. 合并相同食材
3. 估算马来西亚市场价格(RM)
4. 按类别分组
...`;
```

#### 步骤 3：调用豆包 AI（⚠️ 最慢，约 30-60 秒）
```javascript
// 调用 /api/generate-shopping-list
const response = await fetch('/api/generate-shopping-list', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ prompt }),
});
```

在 API 路由中：
```javascript
// 调用豆包 API
const response = await fetch(process.env.DOUBAO_API_ENDPOINT, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${process.env.DOUBAO_API_KEY}`,
  },
  body: JSON.stringify({
    model: 'doubao-seed-1-6-lite-251015',
    messages: [...],
    temperature: 0.3,
    max_tokens: 3000,  // ⚠️ 最大生成 3000 tokens
  }),
});
```

**为什么慢：**
- 豆包 AI 需要理解 21 个菜谱名称
- 需要生成食材清单（每个食材包含：名称、数量、单位、价格、分类）
- `max_tokens: 3000` 很大，生成时间长

#### 步骤 4：解析 JSON 响应（约 0.1 秒）
```javascript
// 提取并清理 JSON
jsonString = jsonString.replace(/,(\s*[\]}])/g, '$1');
result = JSON.parse(jsonString);
```

#### 步骤 5：保存到数据库（约 1-2 秒）
```javascript
// 批量插入购物清单项目
const { error: aiItemsError } = await supabase
  .from('shopping_list_items')
  .insert(shoppingItems);  // 可能有 30-50 个项目
```

#### 步骤 6：前端轮询检查（每 3 秒一次，最多 20 次）
```javascript
// 在 shopping-list/page.tsx 中
useEffect(() => {
  if (isGenerating && checkCount < 20) {
    const timer = setTimeout(() => {
      loadShoppingList();  // 重新查询数据库
      setCheckCount(checkCount + 1);
    }, 3000);  // 每 3 秒检查一次
    return () => clearTimeout(timer);
  }
}, [isGenerating, checkCount]);
```

---

## ⏱️ 时间分解

| 步骤 | 时间 | 占比 |
|------|------|------|
| 1. 创建购物清单记录 | 0.5-1s | 2% |
| 2. 准备 AI 请求 | < 0.1s | 0.5% |
| 3. **调用豆包 AI** | **30-60s** | **95%** |
| 4. 解析 JSON | 0.1s | 0.5% |
| 5. 保存到数据库 | 1-2s | 2% |
| 6. 前端轮询延迟 | 0-3s | - |
| **总计** | **32-66s** | **100%** |

**结论：慢的根本原因是豆包 AI 生成时间长（30-60 秒）**

---

## 🚀 优化方案

### 方案 1：减少 AI 生成的内容量（最有效，推荐）

#### 问题
- `max_tokens: 3000` 太大
- 要求生成完整的购物清单（30-50 个食材）

#### 优化
**减少 `max_tokens` 到 1500：**

```javascript
// 在 generate-shopping-list/route.ts 中
body: JSON.stringify({
  model: process.env.DOUBAO_MODEL || 'doubao-seed-1-6-lite-251015',
  messages: [...],
  temperature: 0.3,
  max_tokens: 1500,  // 改为 1500（减少 50%）
}),
```

**预期效果：**
- 生成时间减少 30-50%
- 从 30-60s → 15-35s
- 购物清单项目可能从 50 个减少到 30-40 个（仍然足够）

---

### 方案 2：简化 AI prompt（中等效果）

#### 问题
- Prompt 太长、要求太复杂

#### 优化
**简化 prompt，减少不必要的要求：**

```javascript
const prompt = `生成购物清单：${recipeNames}

要求：
1. 4人份，一周用量
2. 合并相同食材
3. 按类别分组（新鲜蔬菜、肉类 & 海鲜、调味料、谷物 & 主食、水果、其他）

纯JSON格式：
{"items":[{"name":"洋葱","category":"新鲜蔬菜","quantity":800,"unit":"g","price":4.8}]}`;
```

**移除：**
- `name_en`、`name_ms`（不太需要）
- 复杂的格式说明

**预期效果：**
- 生成时间减少 10-20%
- 从 30-60s → 25-50s

---

### 方案 3：使用更快的模型（效果最好，但可能影响质量）

#### 问题
- 当前使用 `doubao-seed-1-6-lite-251015`

#### 优化
**换用更快的模型（如果可用）：**

根据豆包文档，可能有更快的模型：
- `doubao-seed-1.6-flash`（更快，但可能质量稍低）

```javascript
body: JSON.stringify({
  model: 'doubao-seed-1.6-flash',  // 或其他更快的模型
  messages: [...],
  temperature: 0.3,
  max_tokens: 1500,
}),
```

**预期效果：**
- 生成时间减少 50-70%
- 从 30-60s → 10-20s

---

### 方案 4：优化前端轮询（改善用户体验）

#### 问题
- 每 3 秒查询一次数据库（可能造成不必要的请求）

#### 优化 A：使用 WebSocket 或 Server-Sent Events

**不推荐：** 太复杂，Vercel 支持有限

#### 优化 B：改进轮询策略

```javascript
// 前 10 秒：每 2 秒检查一次
// 10-30 秒：每 3 秒检查一次
// 30 秒后：每 5 秒检查一次

useEffect(() => {
  if (isGenerating && checkCount < 20) {
    let interval = 3000;
    if (checkCount < 5) interval = 2000;      // 前 10 秒：2 秒
    if (checkCount > 10) interval = 5000;     // 30 秒后：5 秒
    
    const timer = setTimeout(() => {
      loadShoppingList();
      setCheckCount(checkCount + 1);
    }, interval);
    
    return () => clearTimeout(timer);
  }
}, [isGenerating, checkCount]);
```

**预期效果：**
- 不减少总时间
- 但前期更快看到结果
- 减少数据库查询次数

---

### 方案 5：添加进度指示器（改善用户体验）

#### 优化
**在购物清单页面显示生成进度：**

```javascript
// 在 shopping-list/page.tsx 中
{isGenerating && (
  <div className="text-center py-12">
    <div className="animate-spin ...">...</div>
    <p className="mt-4">AI 正在智能生成购物清单...</p>
    <p className="text-sm text-gray-500 mt-2">
      预计需要 30-60 秒，请稍候
    </p>
    <div className="mt-4 w-full max-w-xs mx-auto">
      <div className="h-2 bg-gray-200 rounded">
        <div 
          className="h-2 bg-blue-600 rounded transition-all duration-500"
          style={{ width: `${Math.min((checkCount / 20) * 100, 100)}%` }}
        />
      </div>
      <p className="text-xs text-gray-400 mt-2">
        已等待 {checkCount * 3} 秒
      </p>
    </div>
  </div>
)}
```

**预期效果：**
- 不减少总时间
- 但用户体验更好（知道正在进行中）

---

## ✅ 推荐的组合优化方案

### 立即可做（无需修改太多代码）

1. **减少 `max_tokens`**：`3000` → `1500`
   - 预计节省：15-25 秒
   
2. **简化 prompt**：移除不必要的字段
   - 预计节省：5-10 秒

3. **添加进度指示器**：改善用户体验
   - 不减少时间，但体验更好

**总预期效果：**
- 从 30-60 秒 → **20-35 秒**
- 减少约 **40%** 的等待时间

### 后续可做（需要测试）

4. **尝试更快的模型**：如 `doubao-seed-1.6-flash`
   - 预计节省：额外 10-20 秒
   - **最终可能：10-20 秒**

---

## 🎯 无法进一步优化的部分

以下是无法通过代码优化的：

1. **豆包 API 的物理响应时间**
   - 这是 AI 模型推理的固有延迟
   - 只能通过换更快的模型解决

2. **网络延迟**
   - Vercel → 豆包 API 的网络延迟
   - 通常在 100-500ms，影响不大

---

## 📝 总结

购物清单慢的根本原因：
- ✅ 豆包 AI 生成需要 30-60 秒（占总时间的 95%）
- ⚠️ `max_tokens: 3000` 太大
- ⚠️ prompt 复杂

最有效的优化：
1. 减少 `max_tokens` 到 1500
2. 简化 prompt
3. （可选）换更快的模型

这些优化可以将时间从 **30-60 秒** 减少到 **10-35 秒**。

