# 🔍 诊断购物清单 401 错误

## ❌ 问题

膳食计划可以正常生成（说明豆包 API 配置正确），但购物清单生成失败，显示 401 错误。

## 🔍 可能的原因

既然膳食计划可以工作，说明：
- ✅ API Endpoint 是正确的
- ✅ API Key 格式基本正确
- ✅ 环境变量已经配置

但购物清单失败，可能是：

### 1. 环境变量在服务端未生效

**症状**：更新环境变量后没有重新部署

**解决**：更新环境变量后，**必须重新部署**才能生效

### 2. API Key 可能有隐藏字符

**症状**：API Key 复制时包含了多余的空格或换行

**检查方法**：
1. 在 Vercel → Settings → Environment Variables
2. 点击 `DOUBAO_API_KEY` 的 Edit 按钮
3. **全选并删除**旧的 API Key
4. **重新复制粘贴** API Key（确保没有多余空格）
5. 保存并重新部署

### 3. 两个 API 路由的代码略有不同

**症状**：购物清单 API 缺少某些错误处理

**解决**：我已经修复了代码，添加了：
- ✅ 环境变量检查
- ✅ 超时处理（AbortController）
- ✅ 更详细的日志

---

## ✅ 解决步骤

### 步骤 1：检查 API Key 格式

在 Vercel 中：

1. **进入** Settings → Environment Variables
2. **找到** `DOUBAO_API_KEY`
3. **点击** Edit 或值字段
4. **检查**：
   - ✅ 确保没有多余的空格（开头或结尾）
   - ✅ 确保没有换行
   - ✅ 确保是完整的 Key
   - ✅ 如果可能，**删除并重新粘贴**一次

5. **保存**（确保勾选了三个环境）

### 步骤 2：推送代码更新

我已经修复了购物清单 API 的代码，需要推送并部署：

```bash
cd "/Users/huhaotian/未命名文件夹/malaysia-meal-planner"

git add .
git commit -m "Fix: Improve shopping list API error handling and add timeout"
git push origin main
```

Vercel 会自动重新部署。

### 步骤 3：重新部署（如果更新了环境变量）

如果更新了 API Key：

1. 在 Vercel 项目页面
2. 点击 **"Deployments"** 标签
3. 找到最新部署
4. 点击 **"..."** → **"Redeploy"**
5. 等待 2-3 分钟

### 步骤 4：查看 Vercel 日志

部署后，查看日志以诊断问题：

1. 在 Vercel 项目页面
2. 点击 **"Deployments"** → 选择最新部署
3. 点击 **"Functions"** 标签
4. 找到 `/api/generate-shopping-list`
5. 查看日志，应该能看到：
   - `🔧 Using Doubao endpoint for shopping list: ...`
   - `🔧 API Key length: ...`
   - `🔧 API Key prefix: ...`
   - 如果有错误，会显示详细的错误信息

---

## 🔍 诊断要点

### 检查 1：环境变量是否正确传递

在 Vercel 日志中查找：
- `🔧 Using Doubao endpoint for shopping list: ...`（应该显示完整的 URL）
- `🔧 API Key length: ...`（应该是一个大于 0 的数字，例如 50-100）
- `🔧 API Key prefix: ...`（应该显示 API Key 的前 10 个字符）

如果看到 `API Key length: 0`，说明环境变量没有传递。

### 检查 2：API 调用是否成功

在日志中查找：
- `❌ Doubao API error for shopping list: 401 ...`（如果看到这个，说明 API Key 有问题）
- `🔍 Request URL: ...`（确认 URL 是正确的）
- `🔍 API Key prefix: ...`（确认 Key 是否正确传递）

### 检查 3：对比膳食计划 API 的日志

1. 查看 `/api/generate-meal-plan` 的日志（这个可以工作）
2. 对比 `/api/generate-shopping-list` 的日志（这个失败）
3. 看看有什么不同

---

## 💡 常见问题和解决方案

### 问题 1：环境变量未生效

**症状**：更新了环境变量，但错误依然存在

**原因**：没有重新部署

**解决**：
1. 确保保存了环境变量
2. **必须重新部署**（点击 Redeploy）

### 问题 2：API Key 有隐藏字符

**症状**：API Key 看起来正确，但还是 401 错误

**原因**：复制时包含了空格或换行

**解决**：
1. 在 Vercel 中删除旧的 API Key
2. 从豆包控制台**重新复制**完整的 Key
3. **粘贴时注意**不要包含空格
4. 保存并重新部署

### 问题 3：API Key 格式问题

**症状**：`The API key format is incorrect`

**原因**：API Key 格式不符合豆包 API 的要求

**解决**：
1. 检查 API Key 是否符合豆包 API 的要求
2. 确认 API Key 是否完整（没有截断）
3. 如果可能，尝试重新生成 API Key

---

## 🎯 快速诊断步骤

1. **检查 API Key**：在 Vercel 中查看 `DOUBAO_API_KEY` 是否完整
2. **推送代码**：我已经修复了代码，推送并部署
3. **重新部署**：如果更新了环境变量，必须重新部署
4. **查看日志**：在 Vercel 日志中查看详细的错误信息
5. **对比两个 API**：对比膳食计划 API 和购物清单 API 的日志

---

## 📊 我修复的内容

我已经修复了购物清单 API，添加了：

1. ✅ **环境变量检查**（与膳食计划 API 一致）
2. ✅ **超时处理**（AbortController，60秒超时）
3. ✅ **详细日志**（API Key 长度、前缀、错误详情）
4. ✅ **改进的错误处理**（更详细的错误信息）

---

## ✅ 下一步

1. **推送代码**：
   ```bash
   git add .
   git commit -m "Fix: Improve shopping list API"
   git push origin main
   ```

2. **如果更新了 API Key，重新部署**

3. **查看 Vercel 日志**，看看详细的错误信息

4. **告诉我日志中的错误信息**，我可以帮你进一步诊断

---

**推送代码后，Vercel 会自动部署。部署完成后，查看 Vercel 日志，应该能看到更详细的错误信息，这样我们就能知道具体是什么问题了！**

